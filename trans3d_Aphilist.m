function Aphilist2 = trans3d_Aphilist(T,Aphilist,order)
% function Aphilist2 = trans3d_Aphilist(T,Aphilist,order)
%
% Transforms Aphilist into Aphilist2 according to matrix T (3 x 3)
% Note: Order of colums is [val, d/dx1, d/dx2, d/dx3, d^2/dx1^2, d^2/dx1.dx2, d^2/dx1.dx3, d^2/dx2^2, d^2/dx2.dx3, d^2/dx3^2]
Aphilist2 = zeros(size(Aphilist));
Aphilist2(:,1) = Aphilist(:,1); % values unchanged
if order >= 1
    S = inv(T);
    Aphilist2(:,2:4) = Aphilist(:,2:4)*S; % chain rule for 1st derivatives
end % if
if order >= 2
    % chain rule for 2nd derivatives (affine transformation)
    Aphilist2(:,5)  = Aphilist(:,5)*(S(1,1)^2)+ ...
           Aphilist(:,6)*(2*S(2,1)*S(1,1))+ ...
           Aphilist(:,7)*(2*S(3,1)*S(1,1))+ ...
           Aphilist(:,8)*(S(2,1)^2)+ ...
           Aphilist(:,9)*(2*S(3,1)*S(2,1))+ ...
           Aphilist(:,10)*(S(3,1)^2);
    Aphilist2(:,6)  = Aphilist(:,5)*(S(1,1)*S(1,2))+ ...
           Aphilist(:,6)*(S(1,1)*S(2,2)+S(1,2)*S(2,1))+ ...
           Aphilist(:,7)*(S(3,1)*S(1,2)+S(1,1)*S(3,2))+ ...
           Aphilist(:,8)*(S(2,2)*S(2,1))+ ...
           Aphilist(:,9)*(S(3,1)*S(2,2)+S(2,1)*S(3,2))+ ...
           Aphilist(:,10)*(S(3,1)*S(3,2));
    Aphilist2(:,7)  = Aphilist(:,5)*(S(1,1)*S(1,3))+ ...
           Aphilist(:,6)*(S(2,1)*S(1,3)+S(1,1)*S(2,3))+ ...
           Aphilist(:,7)*(S(3,1)*S(1,3)+S(1,1)*S(3,3))+ ...
           Aphilist(:,8)*(S(2,1)*S(2,3))+ ...
           Aphilist(:,9)*(S(3,1)*S(2,3)+S(2,1)*S(3,3))+ ...
           Aphilist(:,10)*(S(3,1)*S(3,3));
    Aphilist2(:,8)  = Aphilist(:,5)*(S(1,2)^2)+ ...
           Aphilist(:,6)*(2*S(2,2)*S(1,2))+ ...
           Aphilist(:,7)*(2*S(3,2)*S(1,2))+ ...
           Aphilist(:,8)*(S(2,2)^2)+ ...
           Aphilist(:,9)*(2*S(3,2)*S(2,2))+ ...
           Aphilist(:,10)*(S(3,2)^2);
    Aphilist2(:,9)  = Aphilist(:,5)*(S(1,2)*S(1,3))+ ...
           Aphilist(:,6)*(S(2,2)*S(1,3)+S(1,2)*S(2,3))+ ...
           Aphilist(:,7)*(S(3,2)*S(1,3)+S(1,2)*S(3,3))+ ...
           Aphilist(:,8)*(S(2,2)*S(2,3))+ ...
           Aphilist(:,9)*(S(3,2)*S(2,3)+S(2,2)*S(3,3))+ ...
           Aphilist(:,10)*(S(3,2)*S(3,3));
    Aphilist2(:,10) = Aphilist(:,5)*(S(1,3)^2)+ ...
           Aphilist(:,6)*(2*S(2,3)*S(1,3))+ ...
           Aphilist(:,7)*(2*S(3,3)*S(1,3))+ ...
           Aphilist(:,8)*(S(2,3)^2)+ ...
           Aphilist(:,9)*(2*S(3,3)*S(2,3))+ ...
           Aphilist(:,10)*(S(3,3)^2);
end % if
end % function

